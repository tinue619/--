<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Cabinet Editor</title>
  <link rel="stylesheet" href="css/main.css">
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  
  <!-- –ü–ê–ù–ï–õ–¨ –†–ï–î–ê–ö–¢–û–†–ê (2D) -->
  <div class="editor-panel panel active" id="editor-panel">
    
    <!-- –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π Header -->
    <div class="editor-header">
      <h1>–†–µ–¥–∞–∫—Ç–æ—Ä</h1>
      <div class="header-actions">
        <button class="header-btn" id="undo-btn" disabled>‚Ü∂</button>
        <button class="header-btn" id="redo-btn" disabled>‚Ü∑</button>
      </div>
    </div>
    
    <!-- Canvas -->
    <div class="canvas-container">
      <canvas id="editor-canvas"></canvas>
    </div>
    
    <!-- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
    <div class="tools-panel">
      <div class="tools-scroll">
        <button class="tool-card active" data-mode="shelf">
          <div class="tool-icon">üì¶</div>
          <div class="tool-name">–ü–æ–ª–∫–∞</div>
        </button>
        
        <button class="tool-card" data-mode="divider">
          <div class="tool-icon">üìè</div>
          <div class="tool-name">–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å</div>
        </button>
        
        <button class="tool-card" data-mode="move">
          <div class="tool-icon">üëÜ</div>
          <div class="tool-name">–î–≤–∏–≥–∞—Ç—å</div>
        </button>
        
        <button class="tool-card delete-tool" data-mode="delete">
          <div class="tool-icon">üóëÔ∏è</div>
          <div class="tool-name">–£–¥–∞–ª–∏—Ç—å</div>
        </button>
        
        <button class="tool-card clear-tool">
          <div class="tool-icon">‚ö†Ô∏è</div>
          <div class="tool-name">–û—á–∏—Å—Ç–∏—Ç—å</div>
        </button>
      </div>
    </div>
    
    <!-- Status Bar -->
    <div class="status-bar">
      <div id="status-text">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∫–∏</div>
    </div>
    
    <!-- –°–∫—Ä—ã—Ç—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ -->
    <div style="display: none;">
      <div class="toolbar">
        <div class="mode-buttons">
          <button class="mode-btn active" data-mode="shelf"></button>
          <button class="mode-btn" data-mode="divider"></button>
          <button class="mode-btn" data-mode="move"></button>
          <button class="mode-btn" data-mode="delete"></button>
        </div>
      </div>
      <button class="clear-btn"></button>
    </div>
  </div>

  <!-- –ü–ê–ù–ï–õ–¨ 3D –ü–†–û–°–ú–û–¢–†–ê -->
  <div class="viewer-panel panel" id="viewer-panel">
    <div id="three-container"></div>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —à–∫–∞—Ñ–µ (—Å–∫—Ä—ã—Ç–∞) -->
    <div class="viewer-info" style="display: none;">
      <h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>
      <div class="stat">
        <label>–®–∏—Ä–∏–Ω–∞</label>
        <span id="stat-width">1000 –º–º</span>
      </div>
      <div class="stat">
        <label>–í—ã—Å–æ—Ç–∞</label>
        <span id="stat-height">2000 –º–º</span>
      </div>
      <div class="stat">
        <label>–ì–ª—É–±–∏–Ω–∞</label>
        <span id="stat-depth">600 –º–º</span>
      </div>
      <div class="stat stat-divider">
        <label>–ü–æ–ª–æ–∫</label>
        <span id="stat-shelves">0</span>
      </div>
      <div class="stat">
        <label>–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π</label>
        <span id="stat-dividers">0</span>
      </div>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
    <div class="saved-indicator" id="saved-indicator">
      ‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ
    </div>
    
    <!-- –°–∫—Ä—ã—Ç–∞—è –ø–∞–Ω–µ–ª—å –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ -->
    <div class="history-panel" id="history-panel" style="display: none;">
      <div class="history-header" id="history-header">
        <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
        <div class="history-controls">
          <button class="history-btn" id="copy-history-btn">üìã</button>
          <button class="history-btn" id="clear-history-btn">üóëÔ∏è</button>
          <button class="history-btn" id="collapse-history-btn">‚ñº</button>
        </div>
      </div>
      <div class="history-content" id="history-content">
        <div class="history-empty">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>
      </div>
    </div>
  </div>
  
  <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è (—Ç–∞–±—ã) -->
  <div class="tabs-container">
    <div class="tabs">
      <button class="tab active" data-panel="editor-panel">
        <span class="tab-icon">üìê</span>
        <span>–†–µ–¥–∞–∫—Ç–æ—Ä</span>
      </button>
      <button class="tab" data-panel="viewer-panel">
        <span class="tab-icon">üëÅÔ∏è</span>
        <span>3D –í–∏–¥</span>
      </button>
      <button class="tab" id="open-history-sheet">
        <span class="tab-icon">üìù</span>
        <span>–ò—Å—Ç–æ—Ä–∏—è</span>
      </button>
    </div>
  </div>

  <!-- BOTTOM SHEETS -->
  
  <!-- Backdrop -->
  <div class="sheet-backdrop" id="sheet-backdrop"></div>
  
  <!-- Sheet: –ò—Å—Ç–æ—Ä–∏—è -->
  <div class="bottom-sheet" id="history-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h2 class="sheet-title">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
      <button class="sheet-close" id="close-history-sheet">‚úï</button>
    </div>
    <div class="sheet-content">
      <div class="history-list" id="history-list"></div>
      
      <div class="sheet-separator"></div>
      
      <div class="sheet-menu">
        <button class="sheet-item" id="copy-history-sheet">
          <div class="sheet-item-icon">üìã</div>
          <div class="sheet-item-content">
            <div class="sheet-item-title">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏</div>
          </div>
        </button>
        <button class="sheet-item destructive" id="clear-history-sheet">
          <div class="sheet-item-icon">üóëÔ∏è</div>
          <div class="sheet-item-content">
            <div class="sheet-item-title">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</div>
          </div>
        </button>
      </div>
    </div>
  </div>

  <script type="module" src="js/main.js"></script>
  
  <!-- Sheet & Tools Management -->
  <script>
    // ========== BOTTOM SHEETS ==========
    const backdrop = document.getElementById('sheet-backdrop');
    const historySheet = document.getElementById('history-sheet');
    const openHistoryBtn = document.getElementById('open-history-sheet');
    const closeHistoryBtn = document.getElementById('close-history-sheet');
    
    let currentSheet = null;
    
    function openSheet(sheet) {
      if (currentSheet && currentSheet !== sheet) {
        closeSheet(currentSheet);
      }
      
      requestAnimationFrame(() => {
        sheet.classList.add('open');
        backdrop.classList.add('visible');
        currentSheet = sheet;
        document.body.style.overflow = 'hidden';
      });
    }
    
    function closeSheet(sheet) {
      sheet.classList.remove('open');
      backdrop.classList.remove('visible');
      currentSheet = null;
      document.body.style.overflow = '';
    }
    
    openHistoryBtn?.addEventListener('click', () => openSheet(historySheet));
    closeHistoryBtn?.addEventListener('click', () => closeSheet(historySheet));
    backdrop.addEventListener('click', () => {
      if (currentSheet) closeSheet(currentSheet);
    });
    
    // –°–≤–∞–π–ø –≤–Ω–∏–∑ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
    let startY = 0;
    let currentY = 0;
    
    document.querySelectorAll('.bottom-sheet').forEach(sheet => {
      const handle = sheet.querySelector('.sheet-handle');
      
      handle.addEventListener('touchstart', (e) => {
        startY = e.touches[0].clientY;
      }, { passive: true });
      
      handle.addEventListener('touchmove', (e) => {
        currentY = e.touches[0].clientY;
        const diff = currentY - startY;
        if (diff > 0) {
          sheet.style.transform = `translateY(${diff}px)`;
        }
      }, { passive: true });
      
      handle.addEventListener('touchend', () => {
        const diff = currentY - startY;
        if (diff > 100) {
          closeSheet(sheet);
        }
        sheet.style.transform = '';
      }, { passive: true });
    });
    
    // –ò—Å—Ç–æ—Ä–∏—è - –∫–Ω–æ–ø–∫–∏
    document.getElementById('copy-history-sheet')?.addEventListener('click', () => {
      document.getElementById('copy-history-btn')?.click();
    });
    
    document.getElementById('clear-history-sheet')?.addEventListener('click', () => {
      document.getElementById('clear-history-btn')?.click();
      closeSheet(historySheet);
    });
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏
    const observer = new MutationObserver(() => {
      const historyContent = document.getElementById('history-content');
      const historyList = document.getElementById('history-list');
      
      if (historyContent && historyList) {
        const logs = historyContent.innerHTML;
        if (logs.includes('–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞')) {
          historyList.innerHTML = '<div class="history-empty">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
        } else {
          historyList.innerHTML = `<div class="history-log">${logs}</div>`;
        }
      }
    });
    
    const historyContent = document.getElementById('history-content');
    if (historyContent) {
      observer.observe(historyContent, { childList: true, subtree: true });
    }
    
    // ========== HORIZONTAL TOOLS ==========
    const toolCards = document.querySelectorAll('.tool-card[data-mode]');
    const clearTool = document.querySelector('.tool-card.clear-tool');
    const statusText = document.getElementById('status-text');
    
    const statusMessages = {
      shelf: '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∫–∏',
      divider: '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è',
      move: '–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ',
      delete: '–£–¥–∞–ª–µ–Ω–∏–µ'
    };
    
    // –í—ã–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
    toolCards.forEach(card => {
      card.addEventListener('click', () => {
        const mode = card.dataset.mode;
        
        // –£–±–∏—Ä–∞–µ–º active —É –≤—Å–µ—Ö
        toolCards.forEach(c => c.classList.remove('active'));
        // –î–æ–±–∞–≤–ª—è–µ–º active –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É
        card.classList.add('active');
        
        // –¢—Ä–∏–≥–≥–µ—Ä–∏–º –∫–ª–∏–∫ –Ω–∞ —Å–∫—Ä—ã—Ç–æ–π –∫–Ω–æ–ø–∫–µ
        const hiddenBtn = document.querySelector(`.mode-btn[data-mode="${mode}"]`);
        if (hiddenBtn) {
          hiddenBtn.click();
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        if (statusText && statusMessages[mode]) {
          statusText.textContent = statusMessages[mode];
        }
        
        // –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
        card.style.transform = 'scale(0.95)';
        setTimeout(() => {
          card.style.transform = '';
        }, 150);
      });
    });
    
    // –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∏—Ç—å
    clearTool?.addEventListener('click', () => {
      const clearBtn = document.querySelector('.clear-btn');
      if (clearBtn) {
        clearBtn.click();
      }
      
      // –ê–Ω–∏–º–∞—Ü–∏—è
      clearTool.style.transform = 'scale(0.95)';
      setTimeout(() => {
        clearTool.style.transform = '';
      }, 150);
    });
    
    // Smooth scroll –¥–ª—è tools panel
    const toolsScroll = document.querySelector('.tools-scroll');
    if (toolsScroll) {
      toolsScroll.addEventListener('scroll', () => {
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∏–ª–∏ snap
      });
    }
  </script>
</body>
</html>
