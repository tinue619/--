<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Cabinet Editor</title>
  <link rel="stylesheet" href="css/main.css">
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  
  <!-- –ü–ê–ù–ï–õ–¨ –†–ï–î–ê–ö–¢–û–†–ê (2D) -->
  <div class="editor-panel panel active" id="editor-panel">
    
    <!-- –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π Toolbar -->
    <div class="toolbar">
      <div class="toolbar-top">
        <h1>–†–µ–¥–∞–∫—Ç–æ—Ä</h1>
        <button class="icon-btn" id="open-tools-sheet">
          <span>‚öôÔ∏è</span>
        </button>
      </div>
      
      <!-- –°–∫—Ä—ã—Ç—ã–µ –∫–Ω–æ–ø–∫–∏ —Ä–µ–∂–∏–º–æ–≤ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å JS -->
      <div class="mode-buttons" style="display: none;">
        <button class="mode-btn active" data-mode="shelf"></button>
        <button class="mode-btn" data-mode="divider"></button>
        <button class="mode-btn" data-mode="move"></button>
        <button class="mode-btn" data-mode="delete"></button>
      </div>
      
      <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞ -->
      <div class="mode-indicator" id="mode-indicator">
        <span class="mode-indicator-icon">üì¶</span>
        <span class="mode-indicator-text">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∫–∏</span>
      </div>
      
      <!-- –ü–ª–∞–≤–∞—é—â–∞—è –ø–∞–Ω–µ–ª—å Undo/Redo -->
      <div class="floating-actions">
        <button class="floating-btn" id="undo-btn" disabled title="–û—Ç–º–µ–Ω–∏—Ç—å">
          <span>‚Ü∂</span>
        </button>
        <button class="floating-btn" id="redo-btn" disabled title="–í–µ—Ä–Ω—É—Ç—å">
          <span>‚Ü∑</span>
        </button>
      </div>
    </div>
    
    <!-- Canvas -->
    <div class="canvas-container">
      <canvas id="editor-canvas"></canvas>
    </div>
    
    <!-- –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π Status -->
    <div class="status">
      <div id="status-text">–†–µ–∂–∏–º: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∫–∏</div>
    </div>
  </div>

  <!-- –ü–ê–ù–ï–õ–¨ 3D –ü–†–û–°–ú–û–¢–†–ê -->
  <div class="viewer-panel panel" id="viewer-panel">
    <div id="three-container"></div>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —à–∫–∞—Ñ–µ (—Å–∫—Ä—ã—Ç–∞) -->
    <div class="viewer-info" style="display: none;">
      <h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>
      <div class="stat">
        <label>–®–∏—Ä–∏–Ω–∞</label>
        <span id="stat-width">1000 –º–º</span>
      </div>
      <div class="stat">
        <label>–í—ã—Å–æ—Ç–∞</label>
        <span id="stat-height">2000 –º–º</span>
      </div>
      <div class="stat">
        <label>–ì–ª—É–±–∏–Ω–∞</label>
        <span id="stat-depth">600 –º–º</span>
      </div>
      <div class="stat stat-divider">
        <label>–ü–æ–ª–æ–∫</label>
        <span id="stat-shelves">0</span>
      </div>
      <div class="stat">
        <label>–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π</label>
        <span id="stat-dividers">0</span>
      </div>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
    <div class="saved-indicator" id="saved-indicator">
      ‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ
    </div>
    
    <!-- –°–∫—Ä—ã—Ç–∞—è –ø–∞–Ω–µ–ª—å –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ -->
    <div class="history-panel" id="history-panel" style="display: none;">
      <div class="history-header" id="history-header">
        <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
        <div class="history-controls">
          <button class="history-btn" id="copy-history-btn">üìã</button>
          <button class="history-btn" id="clear-history-btn">üóëÔ∏è</button>
          <button class="history-btn" id="collapse-history-btn">‚ñº</button>
        </div>
      </div>
      <div class="history-content" id="history-content">
        <div class="history-empty">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>
      </div>
    </div>
  </div>
  
  <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è (—Ç–∞–±—ã) -->
  <div class="tabs-container">
    <div class="tabs">
      <button class="tab active" data-panel="editor-panel">
        <span class="tab-icon">üìê</span>
        <span>–†–µ–¥–∞–∫—Ç–æ—Ä</span>
      </button>
      <button class="tab" data-panel="viewer-panel">
        <span class="tab-icon">üëÅÔ∏è</span>
        <span>3D –í–∏–¥</span>
      </button>
      <button class="tab" id="open-history-sheet">
        <span class="tab-icon">üìù</span>
        <span>–ò—Å—Ç–æ—Ä–∏—è</span>
      </button>
    </div>
  </div>

  <!-- BOTTOM SHEETS -->
  
  <!-- Backdrop -->
  <div class="sheet-backdrop" id="sheet-backdrop"></div>
  
  <!-- Sheet: –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã -->
  <div class="bottom-sheet" id="tools-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h2 class="sheet-title">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h2>
    </div>
    <div class="sheet-content">
      <div class="sheet-menu">
        <button class="sheet-item active" data-mode="shelf">
          <div class="sheet-item-icon">üì¶</div>
          <div class="sheet-item-content">
            <div class="sheet-item-title">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–∫—É</div>
            <div class="sheet-item-subtitle">–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å</div>
          </div>
          <div class="sheet-item-check">‚úì</div>
        </button>
        <button class="sheet-item" data-mode="divider">
          <div class="sheet-item-icon">üìè</div>
          <div class="sheet-item-content">
            <div class="sheet-item-title">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å</div>
            <div class="sheet-item-subtitle">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å</div>
          </div>
          <div class="sheet-item-check">‚úì</div>
        </button>
        <button class="sheet-item" data-mode="move">
          <div class="sheet-item-icon">üëÜ</div>
          <div class="sheet-item-content">
            <div class="sheet-item-title">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</div>
            <div class="sheet-item-subtitle">–ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª–æ–∂–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞</div>
          </div>
          <div class="sheet-item-check">‚úì</div>
        </button>
        <button class="sheet-item" data-mode="delete">
          <div class="sheet-item-icon">üóëÔ∏è</div>
          <div class="sheet-item-content">
            <div class="sheet-item-title">–£–¥–∞–ª–∏—Ç—å</div>
            <div class="sheet-item-subtitle">–£–±—Ä–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç</div>
          </div>
          <div class="sheet-item-check">‚úì</div>
        </button>
      </div>
      
      <div class="sheet-separator"></div>
      
      <div class="sheet-menu">
        <button class="sheet-item destructive" class="clear-btn">
          <div class="sheet-item-icon">‚ö†Ô∏è</div>
          <div class="sheet-item-content">
            <div class="sheet-item-title">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</div>
          </div>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Sheet: –ò—Å—Ç–æ—Ä–∏—è -->
  <div class="bottom-sheet" id="history-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h2 class="sheet-title">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
      <button class="sheet-close" id="close-history-sheet">‚úï</button>
    </div>
    <div class="sheet-content">
      <div class="history-list" id="history-list"></div>
      
      <div class="sheet-separator"></div>
      
      <div class="sheet-menu">
        <button class="sheet-item" id="copy-history-sheet">
          <div class="sheet-item-icon">üìã</div>
          <div class="sheet-item-content">
            <div class="sheet-item-title">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏</div>
          </div>
        </button>
        <button class="sheet-item destructive" id="clear-history-sheet">
          <div class="sheet-item-icon">üóëÔ∏è</div>
          <div class="sheet-item-content">
            <div class="sheet-item-title">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</div>
          </div>
        </button>
      </div>
    </div>
  </div>

  <script type="module" src="js/main.js"></script>
  
  <!-- Sheet Management -->
  <script>
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ bottom sheets
    const backdrop = document.getElementById('sheet-backdrop');
    const toolsSheet = document.getElementById('tools-sheet');
    const historySheet = document.getElementById('history-sheet');
    const openToolsBtn = document.getElementById('open-tools-sheet');
    const openHistoryBtn = document.getElementById('open-history-sheet');
    const closeHistoryBtn = document.getElementById('close-history-sheet');
    
    let currentSheet = null;
    let startY = 0;
    let currentY = 0;
    
    function openSheet(sheet) {
      if (currentSheet && currentSheet !== sheet) {
        closeSheet(currentSheet);
      }
      
      requestAnimationFrame(() => {
        sheet.classList.add('open');
        backdrop.classList.add('visible');
        currentSheet = sheet;
        document.body.style.overflow = 'hidden';
      });
    }
    
    function closeSheet(sheet) {
      sheet.classList.remove('open');
      backdrop.classList.remove('visible');
      currentSheet = null;
      document.body.style.overflow = '';
    }
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ
    openToolsBtn?.addEventListener('click', () => openSheet(toolsSheet));
    openHistoryBtn?.addEventListener('click', () => openSheet(historySheet));
    closeHistoryBtn?.addEventListener('click', () => closeSheet(historySheet));
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ backdrop
    backdrop.addEventListener('click', () => {
      if (currentSheet) closeSheet(currentSheet);
    });
    
    // –°–≤–∞–π–ø –≤–Ω–∏–∑ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
    document.querySelectorAll('.bottom-sheet').forEach(sheet => {
      const handle = sheet.querySelector('.sheet-handle');
      
      handle.addEventListener('touchstart', (e) => {
        startY = e.touches[0].clientY;
      }, { passive: true });
      
      handle.addEventListener('touchmove', (e) => {
        currentY = e.touches[0].clientY;
        const diff = currentY - startY;
        if (diff > 0) {
          sheet.style.transform = `translateY(${diff}px)`;
        }
      }, { passive: true });
      
      handle.addEventListener('touchend', () => {
        const diff = currentY - startY;
        if (diff > 100) {
          closeSheet(sheet);
        }
        sheet.style.transform = '';
      }, { passive: true });
    });
    
    // –í—ã–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –≤ tools sheet
    document.querySelectorAll('.sheet-item[data-mode]').forEach(item => {
      item.addEventListener('click', () => {
        const mode = item.dataset.mode;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –≤ sheet
        document.querySelectorAll('.sheet-item[data-mode]').forEach(i => {
          i.classList.remove('active');
        });
        item.classList.add('active');
        
        // –¢—Ä–∏–≥–≥–µ—Ä–∏–º –∫–ª–∏–∫ –Ω–∞ —Å–∫—Ä—ã—Ç–æ–π –∫–Ω–æ–ø–∫–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å JS
        const hiddenBtn = document.querySelector(`.mode-btn[data-mode="${mode}"]`);
        if (hiddenBtn) {
          hiddenBtn.click();
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞
        const modeIndicator = document.getElementById('mode-indicator');
        const icons = {
          shelf: 'üì¶',
          divider: 'üìè',
          move: 'üëÜ',
          delete: 'üóëÔ∏è'
        };
        const texts = {
          shelf: '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∫–∏',
          divider: '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è',
          move: '–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ',
          delete: '–£–¥–∞–ª–µ–Ω–∏–µ'
        };
        
        modeIndicator.querySelector('.mode-indicator-icon').textContent = icons[mode];
        modeIndicator.querySelector('.mode-indicator-text').textContent = texts[mode];
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º sheet —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
        setTimeout(() => {
          closeSheet(toolsSheet);
        }, 300);
      });
    });
    
    // –ö–Ω–æ–ø–∫–∞ "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë" –≤ tools sheet
    document.querySelector('.sheet-item.destructive')?.addEventListener('click', () => {
      const clearBtn = document.querySelector('.clear-btn');
      if (clearBtn) {
        clearBtn.click();
      }
      closeSheet(toolsSheet);
    });
    
    // –ö–Ω–æ–ø–∫–∏ –≤ history sheet
    document.getElementById('copy-history-sheet')?.addEventListener('click', () => {
      document.getElementById('copy-history-btn')?.click();
    });
    
    document.getElementById('clear-history-sheet')?.addEventListener('click', () => {
      document.getElementById('clear-history-btn')?.click();
      closeSheet(historySheet);
    });
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑ —Å–∫—Ä—ã—Ç–æ–π –ø–∞–Ω–µ–ª–∏ –≤ sheet
    const observer = new MutationObserver(() => {
      const historyContent = document.getElementById('history-content');
      const historyList = document.getElementById('history-list');
      
      if (historyContent && historyList) {
        // –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (–∫—Ä–æ–º–µ –ø—É—Å—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è)
        const logs = historyContent.innerHTML;
        if (logs.includes('–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞')) {
          historyList.innerHTML = '<div class="history-empty">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
        } else {
          historyList.innerHTML = `<div class="history-log">${logs}</div>`;
        }
      }
    });
    
    const historyContent = document.getElementById('history-content');
    if (historyContent) {
      observer.observe(historyContent, { childList: true, subtree: true });
    }
  </script>
</body>
</html>
