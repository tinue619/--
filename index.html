<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Cabinet Editor</title>
  <link rel="stylesheet" href="css/main.css">
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  
  <!-- –ü–ê–ù–ï–õ–¨ –†–ï–î–ê–ö–¢–û–†–ê (2D) -->
  <div class="editor-panel panel active" id="editor-panel">
    
    <!-- –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π Header -->
    <div class="editor-header">
      <h1>–†–µ–¥–∞–∫—Ç–æ—Ä</h1>
      <div class="header-actions">
        <button class="header-btn" id="undo-btn" disabled>‚Ü∂</button>
        <button class="header-btn" id="redo-btn" disabled>‚Ü∑</button>
      </div>
    </div>
    
    <!-- Canvas -->
    <div class="canvas-container">
      <canvas id="editor-canvas"></canvas>
    </div>
    
    <!-- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
    <div class="tools-panel">
      <div class="tools-scroll">
        <button class="tool-card active" data-mode="shelf">
          <div class="tool-icon">üì¶</div>
          <div class="tool-name">–ü–æ–ª–∫–∞</div>
        </button>
        
        <button class="tool-card" data-mode="divider">
          <div class="tool-icon">üìè</div>
          <div class="tool-name">–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å</div>
        </button>
        
        <button class="tool-card" data-mode="move">
          <div class="tool-icon">üëÜ</div>
          <div class="tool-name">–î–≤–∏–≥–∞—Ç—å</div>
        </button>
        
        <button class="tool-card delete-tool" data-mode="delete">
          <div class="tool-icon">üóëÔ∏è</div>
          <div class="tool-name">–£–¥–∞–ª–∏—Ç—å</div>
        </button>
        
        <button class="tool-card clear-tool">
          <div class="tool-icon">‚ö†Ô∏è</div>
          <div class="tool-name">–û—á–∏—Å—Ç–∏—Ç—å</div>
        </button>
      </div>
    </div>
    
    <!-- Status Bar -->
    <div class="status-bar">
      <div id="status-text">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∫–∏</div>
    </div>
    
    <!-- –°–∫—Ä—ã—Ç—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ -->
    <div style="display: none;">
      <div class="toolbar">
        <div class="mode-buttons">
          <button class="mode-btn active" data-mode="shelf"></button>
          <button class="mode-btn" data-mode="divider"></button>
          <button class="mode-btn" data-mode="move"></button>
          <button class="mode-btn" data-mode="delete"></button>
        </div>
      </div>
      <button class="clear-btn"></button>
    </div>
  </div>

  <!-- –ü–ê–ù–ï–õ–¨ 3D –ü–†–û–°–ú–û–¢–†–ê -->
  <div class="viewer-panel panel" id="viewer-panel">
    <div id="three-container"></div>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —à–∫–∞—Ñ–µ (—Å–∫—Ä—ã—Ç–∞) -->
    <div class="viewer-info" style="display: none;">
      <h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>
      <div class="stat">
        <label>–®–∏—Ä–∏–Ω–∞</label>
        <span id="stat-width">1000 –º–º</span>
      </div>
      <div class="stat">
        <label>–í—ã—Å–æ—Ç–∞</label>
        <span id="stat-height">2000 –º–º</span>
      </div>
      <div class="stat">
        <label>–ì–ª—É–±–∏–Ω–∞</label>
        <span id="stat-depth">600 –º–º</span>
      </div>
      <div class="stat stat-divider">
        <label>–ü–æ–ª–æ–∫</label>
        <span id="stat-shelves">0</span>
      </div>
      <div class="stat">
        <label>–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π</label>
        <span id="stat-dividers">0</span>
      </div>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
    <div class="saved-indicator" id="saved-indicator">
      ‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ
    </div>
    
    <!-- –°–∫—Ä—ã—Ç–∞—è –ø–∞–Ω–µ–ª—å –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ -->
    <div class="history-panel" id="history-panel" style="display: none;">
      <div class="history-header" id="history-header">
        <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
        <div class="history-controls">
          <button class="history-btn" id="copy-history-btn">üìã</button>
          <button class="history-btn" id="clear-history-btn">üóëÔ∏è</button>
          <button class="history-btn" id="collapse-history-btn">‚ñº</button>
        </div>
      </div>
      <div class="history-content" id="history-content">
        <div class="history-empty">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>
      </div>
    </div>
  </div>

  <!-- –ü–ê–ù–ï–õ–¨ –ú–ï–ù–Æ -->
  <div class="menu-panel panel" id="menu-panel">
    <div class="menu-header">
      <h1>–ú–µ–Ω—é</h1>
    </div>
    
    <div class="menu-content">
      <div class="menu-grid">
        
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞: –ò—Å—Ç–æ—Ä–∏—è -->
        <button class="menu-card" data-sheet="history-sheet">
          <div class="menu-card-icon">üìù</div>
          <div class="menu-card-title">–ò—Å—Ç–æ—Ä–∏—è</div>
          <div class="menu-card-subtitle">–ñ—É—Ä–Ω–∞–ª –∏–∑–º–µ–Ω–µ–Ω–∏–π</div>
        </button>
        
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞: –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è -->
        <button class="menu-card" data-sheet="spec-sheet">
          <div class="menu-card-icon">üìã</div>
          <div class="menu-card-title">–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è</div>
          <div class="menu-card-subtitle">–°–ø–∏—Å–æ–∫ –¥–µ—Ç–∞–ª–µ–π</div>
        </button>
        
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à–∫–∞—Ñ–∞ -->
        <button class="menu-card" data-sheet="cabinet-settings-sheet">
          <div class="menu-card-icon">‚öôÔ∏è</div>
          <div class="menu-card-title">–†–∞–∑–º–µ—Ä—ã</div>
          <div class="menu-card-subtitle">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∫–∞—Ñ–∞</div>
        </button>
        
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞: –≠–∫—Å–ø–æ—Ä—Ç -->
        <button class="menu-card" data-sheet="export-sheet">
          <div class="menu-card-icon">üì§</div>
          <div class="menu-card-title">–≠–∫—Å–ø–æ—Ä—Ç</div>
          <div class="menu-card-subtitle">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</div>
        </button>
        
      </div>
    </div>
  </div>
  
  <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è (—Ç–∞–±—ã) -->
  <div class="tabs-container">
    <div class="tabs">
      <button class="tab active" data-panel="editor-panel">
        <span class="tab-icon">üìê</span>
        <span>–†–µ–¥–∞–∫—Ç–æ—Ä</span>
      </button>
      <button class="tab" data-panel="viewer-panel">
        <span class="tab-icon">üëÅÔ∏è</span>
        <span>3D –í–∏–¥</span>
      </button>
      <button class="tab" data-panel="menu-panel">
        <span class="tab-icon">‚ò∞</span>
        <span>–ú–µ–Ω—é</span>
      </button>
    </div>
  </div>

  <!-- BOTTOM SHEETS -->
  
  <!-- Backdrop -->
  <div class="sheet-backdrop" id="sheet-backdrop"></div>
  
  <!-- Sheet: –ò—Å—Ç–æ—Ä–∏—è -->
  <div class="bottom-sheet" id="history-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h2 class="sheet-title">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
      <button class="sheet-close">‚úï</button>
    </div>
    <div class="sheet-content">
      <div class="history-list" id="history-list"></div>
      
      <div class="sheet-separator"></div>
      
      <div class="sheet-menu">
        <button class="sheet-item" id="copy-history-sheet">
          <div class="sheet-item-icon">üìã</div>
          <div class="sheet-item-content">
            <div class="sheet-item-title">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏</div>
          </div>
        </button>
        <button class="sheet-item destructive" id="clear-history-sheet">
          <div class="sheet-item-icon">üóëÔ∏è</div>
          <div class="sheet-item-content">
            <div class="sheet-item-title">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</div>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- Sheet: –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è -->
  <div class="bottom-sheet" id="spec-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h2 class="sheet-title">–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–µ—Ç–∞–ª–µ–π</h2>
      <button class="sheet-close">‚úï</button>
    </div>
    <div class="sheet-content">
      <div id="spec-table-container" style="padding: var(--space-4);">
        <!-- –¢–∞–±–ª–∏—Ü–∞ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
    </div>
  </div>

  <!-- Sheet: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à–∫–∞—Ñ–∞ -->
  <div class="bottom-sheet" id="cabinet-settings-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h2 class="sheet-title">–†–∞–∑–º–µ—Ä—ã —à–∫–∞—Ñ–∞</h2>
      <button class="sheet-close">‚úï</button>
    </div>
    <div class="sheet-content">
      <div style="padding: var(--space-4); text-align: center; color: var(--text-tertiary);">
        <p>–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
      </div>
    </div>
  </div>

  <!-- Sheet: –≠–∫—Å–ø–æ—Ä—Ç -->
  <div class="bottom-sheet" id="export-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h2 class="sheet-title">–≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞</h2>
      <button class="sheet-close">‚úï</button>
    </div>
    <div class="sheet-content">
      <div style="padding: var(--space-4); text-align: center; color: var(--text-tertiary);">
        <p>–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
      </div>
    </div>
  </div>

  <script type="module" src="js/main.js"></script>
  
  <!-- Sheet & Tools Management -->
  <script>
    // ========== BOTTOM SHEETS ==========
    const backdrop = document.getElementById('sheet-backdrop');
    const sheets = document.querySelectorAll('.bottom-sheet');
    const closeButtons = document.querySelectorAll('.sheet-close');
    
    let currentSheet = null;
    
    function openSheet(sheet) {
      if (currentSheet && currentSheet !== sheet) {
        closeSheet(currentSheet);
      }
      
      requestAnimationFrame(() => {
        sheet.classList.add('open');
        backdrop.classList.add('visible');
        currentSheet = sheet;
        document.body.style.overflow = 'hidden';
      });
    }
    
    function closeSheet(sheet) {
      sheet.classList.remove('open');
      backdrop.classList.remove('visible');
      currentSheet = null;
      document.body.style.overflow = '';
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–Ω–æ–ø–∫–µ X
    closeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        if (currentSheet) closeSheet(currentSheet);
      });
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ backdrop
    backdrop.addEventListener('click', () => {
      if (currentSheet) closeSheet(currentSheet);
    });
    
    // –°–≤–∞–π–ø –≤–Ω–∏–∑ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
    let startY = 0;
    let currentY = 0;
    
    sheets.forEach(sheet => {
      const handle = sheet.querySelector('.sheet-handle');
      
      handle.addEventListener('touchstart', (e) => {
        startY = e.touches[0].clientY;
      }, { passive: true });
      
      handle.addEventListener('touchmove', (e) => {
        currentY = e.touches[0].clientY;
        const diff = currentY - startY;
        if (diff > 0) {
          sheet.style.transform = `translateY(${diff}px)`;
        }
      }, { passive: true });
      
      handle.addEventListener('touchend', () => {
        const diff = currentY - startY;
        if (diff > 100) {
          closeSheet(sheet);
        }
        sheet.style.transform = '';
      }, { passive: true });
    });
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ sheets –∏–∑ –∫–∞—Ä—Ç–æ—á–µ–∫ –º–µ–Ω—é
    document.querySelectorAll('.menu-card[data-sheet]').forEach(card => {
      card.addEventListener('click', () => {
        const sheetId = card.dataset.sheet;
        const sheet = document.getElementById(sheetId);
        if (sheet) {
          openSheet(sheet);
        }
      });
    });
    
    // –ò—Å—Ç–æ—Ä–∏—è - –∫–Ω–æ–ø–∫–∏
    document.getElementById('copy-history-sheet')?.addEventListener('click', () => {
      document.getElementById('copy-history-btn')?.click();
    });
    
    document.getElementById('clear-history-sheet')?.addEventListener('click', () => {
      document.getElementById('clear-history-btn')?.click();
      if (currentSheet) closeSheet(currentSheet);
    });
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏
    const observer = new MutationObserver(() => {
      const historyContent = document.getElementById('history-content');
      const historyList = document.getElementById('history-list');
      
      if (historyContent && historyList) {
        const logs = historyContent.innerHTML;
        if (logs.includes('–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞')) {
          historyList.innerHTML = '<div class="history-empty">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
        } else {
          historyList.innerHTML = `<div class="history-log">${logs}</div>`;
        }
      }
    });
    
    const historyContent = document.getElementById('history-content');
    if (historyContent) {
      observer.observe(historyContent, { childList: true, subtree: true });
    }
    
    // ========== HORIZONTAL TOOLS ==========
    const toolCards = document.querySelectorAll('.tool-card[data-mode]');
    const clearTool = document.querySelector('.tool-card.clear-tool');
    const statusText = document.getElementById('status-text');
    
    const statusMessages = {
      shelf: '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∫–∏',
      divider: '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è',
      move: '–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ',
      delete: '–£–¥–∞–ª–µ–Ω–∏–µ'
    };
    
    // –í—ã–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
    toolCards.forEach(card => {
      card.addEventListener('click', () => {
        const mode = card.dataset.mode;
        
        // –£–±–∏—Ä–∞–µ–º active —É –≤—Å–µ—Ö
        toolCards.forEach(c => c.classList.remove('active'));
        // –î–æ–±–∞–≤–ª—è–µ–º active –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É
        card.classList.add('active');
        
        // –¢—Ä–∏–≥–≥–µ—Ä–∏–º –∫–ª–∏–∫ –Ω–∞ —Å–∫—Ä—ã—Ç–æ–π –∫–Ω–æ–ø–∫–µ
        const hiddenBtn = document.querySelector(`.mode-btn[data-mode="${mode}"]`);
        if (hiddenBtn) {
          hiddenBtn.click();
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        if (statusText && statusMessages[mode]) {
          statusText.textContent = statusMessages[mode];
        }
        
        // –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
        card.style.transform = 'scale(0.95)';
        setTimeout(() => {
          card.style.transform = '';
        }, 150);
      });
    });
    
    // –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∏—Ç—å
    clearTool?.addEventListener('click', () => {
      const clearBtn = document.querySelector('.clear-btn');
      if (clearBtn) {
        clearBtn.click();
      }
      
      // –ê–Ω–∏–º–∞—Ü–∏—è
      clearTool.style.transform = 'scale(0.95)';
      setTimeout(() => {
        clearTool.style.transform = '';
      }, 150);
    });
    
    // ========== SPECIFICATION TABLE ==========
    function updateSpecification() {
      const container = document.getElementById('spec-table-container');
      if (!container || !window.cabinetApp) return;
      
      const app = window.cabinetApp;
      const cab = app.cabinet;
      
      // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–∞–Ω–µ–ª–∏: —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ + –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ
      const allPanels = [
        { type: 'left-side', x: 0, y: 0, width: 16, height: cab.height },
        { type: 'right-side', x: cab.width - 16, y: 0, width: 16, height: cab.height },
        { type: 'bottom', x: 16, y: 0, width: cab.width - 32, height: 16 },
        { type: 'top', x: 16, y: cab.height - 16, width: cab.width - 32, height: 16 },
        ...Array.from(app.panels.values()).map(p => ({
          type: p.type,
          x: p.position.x,
          y: p.position.y,
          width: p.bounds.width,
          height: p.bounds.height
        }))
      ];
      
      if (allPanels.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-tertiary); padding: var(--space-6);"><p>–ù–µ—Ç –ø–∞–Ω–µ–ª–µ–π</p></div>';
        return;
      }
      
      let html = '<table class="spec-table"><thead><tr><th>‚Ññ</th><th>–¢–∏–ø</th><th>X</th><th>Y</th><th>–®–∏—Ä–∏–Ω–∞</th><th>–í—ã—Å–æ—Ç–∞</th></tr></thead><tbody>';
      
      allPanels.forEach((panel, index) => {
        const typeNames = {
          'left-side': '–õ–µ–≤–∞—è –±–æ–∫–æ–≤–∏–Ω–∞',
          'right-side': '–ü—Ä–∞–≤–∞—è –±–æ–∫–æ–≤–∏–Ω–∞',
          'bottom': '–î–Ω–æ',
          'top': '–ö—Ä—ã—à–∞',
          'shelf': '–ü–æ–ª–∫–∞',
          'divider': '–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å',
          'rib': '–†–µ–±—Ä–æ'
        };
        
        html += `<tr>
          <td>${index + 1}</td>
          <td>${typeNames[panel.type] || panel.type}</td>
          <td>${Math.round(panel.x)} –º–º</td>
          <td>${Math.round(panel.y)} –º–º</td>
          <td>${Math.round(panel.width)} –º–º</td>
          <td>${Math.round(panel.height)} –º–º</td>
        </tr>`;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ sheet
    document.querySelector('[data-sheet="spec-sheet"]')?.addEventListener('click', () => {
      setTimeout(updateSpecification, 100);
    });
  </script>
</body>
</html>
